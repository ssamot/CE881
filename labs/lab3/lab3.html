<H3><A name=Introduction>Introduction</A></H3>
	<p>In the previous lab we implemented a simple puzzle game.&nbsp; While this 
	&quot;sort of worked&quot; it fell short of a typical app in a number of ways:</p>
	<ul>
		<li>No retention of state: puzzle state would be lost after a device 
		orientation change</li>
		<li>No retention of state after the app has been destroyed and recreated</li>
		<li>The app consisted of a single screen: most apps involve more than 
		this</li>
	</ul>
	<p>You'll now work through extending the app in the following ways:</p>
	<ul>
		<li>Temporary saving of state in a Bundle</li>
		<li>Addition of an explanation screen: we'll do this using a WebView to 
		display an HTML page</li>
		<li>Adding an Alert Dialog to query whether a user really wants to leave 
		the app</li>
		<li>Saving the state permanently</li>
	</ul>
	<p>There is also an exercise to add more features to the app; a solution 
	will be circulated later in the course.</p>
	<p>In the further reading section there is a link to a moderately complex 
	ActivityLifecycle demonstration app.&nbsp; Prior to studying the app it is a 
	good idea to simply override the lifecycle methods in your main activity in 
	order to gain a greater understanding of when the lifecycle events occur.&nbsp; 
	You can do this simply by writing messages to the LogCat.&nbsp; The methods 
	to override are:</p>
	<ul>
		<li>onCreate()&nbsp; </li>
		<li>onStart()</li>
		<li>onResume()</li>
		<li>onPause()</li>
		<li>onStop()</li>
		<li>onDestroy()</li>
	</ul>
	<p>Don't forget to always call the superclass method first!</p>
	<h3><a name="Saving State">Saving State</a></h3>
	<p>Currently the underlying state of the app is stored in the LightsModel 
	object.&nbsp; Therefore it is sufficient to save a copy of this between 
	device orientation transitions.&nbsp; There are two methods that can be 
	overriden in the Activity class to handle this easily: they are 
	<strong>onSaveInstanceState</strong> and <strong>onRestoreInstanceState</strong>.&nbsp; An object that holds 
	the current state may contain many fields, so rather than extracting and 
	saving each one separately it is easier to serialize the entire model 
	object, and put this into the Bundle.&nbsp; For more details of what can be 
	done with Bundle objects refer to the
	<a href="http://developer.android.com/reference/android/os/Bundle.html">
	Bundle documentation</a>.&nbsp; </p>
	<p>For now we just need to be able to store and 
	retrieve objects.&nbsp; The way we use a bundle is as a set of maps for each 
	specific data type we wish to store.&nbsp; In order to save and load the 
	model we define a static String referred to as <strong>modelKey</strong>.&nbsp; 
	The code to save and load the model in our main Activity class is then as 
	shown below.&nbsp; Note that we're using the <strong>putSerializable()</strong> 
	method of Bundle: for this to work the object (in this case LightsModel) 
	must be declared serializaable, as in:</p>
	<pre>public class LightsModel implements Serializable {
   // rest of class definition omitted
   // note that any other Object fields would
   // also need to be declared serializable
   // but LightsModel does not have any
}</pre>
	<p><img alt="Saving and Restoring state" src="img13.gif"></p>
	<p>Note that I've used a call to getModel() to get the current model.&nbsp; 
	This is defined as follows:</p>
	<p><img alt="getModel() method" src="img15.gif"></p>
	<p>Where <strong>nDefault</strong> is a static int declaring the default size of n x n grid 
	use for the model.&nbsp; In this way a valid model is always stored.</p>
	<p>Check that this works by changing the device orientation and confirming 
	that the state is retained.&nbsp; This can be done using &lt;CTRL&gt;&lt;F11&gt;.</p>
	<p>A working solution to the LightsOn puzzle this far can be found
	<a href="LightsOn.zip">here</a>.&nbsp; Note that compared to the code 
	presented in the previous lab, the coupling between the different classes 
	has been reduced.&nbsp; In particular, LightsView no longer keeps a 
	reference to a LightsModel object.&nbsp; It now only keeps a reference to 
	the parent activity, and then calls the getModel method of that whenever it 
	needs access to the LightsModel object.&nbsp; <strong>Question</strong>: why 
	is this better (if indeed it is!)?</p>
	<p>&nbsp;</p>
	<h3><a name="Adding Instructions">Adding Instructions</a></h3>
	<p>Although many apps are self explanatory you may want to add some 
	instructions or other form of documentation or company information, and a good way to do this is to 
	provide an HTML file.&nbsp; This can include images as necessary.&nbsp; </p>
	<p>We'll do this initially by adding a new <strong>Activity.</strong></p>
	<p>The new activity is called <strong>AboutActivity</strong>: it's main purpose is to display 
	a <strong>WebView</strong>.&nbsp; A WebView acts as an embedded web browser.&nbsp; </p>
	<p>Beyond this, we enable the &quot;up&quot; arrow in the action bar in 
	its onCreate method, and then also write a method to handle that.&nbsp; 
	Hence the code is as follows:</p>
	<p><img alt="AboutActivity" src="img17.jpg"></p>
	<p>In order for this to work you'll need an HTML file called 
	About.html.&nbsp; This should be placed in a directory called <strong>
	assets/html</strong>.&nbsp; I suggest you include an image to verify that 
	image inclusion works properly.&nbsp; A sample HTML file plus images can be 
	found <a href="html.zip">here</a>.&nbsp; To use this extract it to your 
	project's assets directory (so the file would appear as <strong>
	assets/html/About.html</strong>.)</p>
	<p>The next step is to link in the AboutActivity to the main Activity in 
	some way.&nbsp; Here we'll add it to the options menu.&nbsp; This is done by 
	adding the following code to the main Activity class:</p>
	<p><img alt="Adding a menu item" src="img1A.gif"></p>
	<p>Finally, in order for this to work we need to add the new Activity to the 
	AndroidManifest.xml file as follows:</p>
	<p><img alt="Updated Manifest File" src="img1C.gif"></p>
	<p>Then, with a suitable HTML file plus image(s), you can see an about 
	activity such as the following:</p>
	<p><img alt="About Screen" height="480" src="AboutScreen.png" width="270"></p>
	<p>Note the &quot;&lt;&quot; arrow on the Action Bar - this is the &quot;Up Arrow&quot; we set up 
	with the line getActionBar().setDisplayHomeAsUpEnabled(true);</p>
	<h3><a name="Splash Screen">Splash Screen</a></h3>
	<p>Many games have a significant loading time, and use a &quot;splash screen&quot; to 
	advertise the publisher and indicate to the user (and the Android system) 
	that the app is doing something.</p>
	<p>A technique for doing this using an AsyncTask was covered in the 
	<a href="../../lectures/LayoutBasics.pptx">Layouts</a> 
	lecture notes, and is included in the <a href="LayoutTest.zip">LayoutTest.zip</a> 
	project.&nbsp; 
	Download and run the LayoutTest project and confirm by inspecting the LogCat 
	that the naive threading approach to creating a transient splash screen does 
	indeed cause an exception to be thrown.</p>
	<p>Using the AsyncTask approach add a spash screen that should show for a few seconds 
	when the app is first launched.&nbsp; This could be an HTML page or a 
	TextView, or really any type of view of your choice.</p>
	<p>Note: the splash screen should not be shown after a device orientation 
	transition.&nbsp; This will require some conditional logic to achieve this.&nbsp; 
	What condition can you test to check whether the spash screen should be 
	shown?</p>
	<h3><a name="Dialogs">Dialogs</a></h3>
	<p>Dialogs are modal views that require user interaction before moving on: 
	the interaction may cause a return to the previous acitvity, or quitting 
	it, or moving to a new activity.</p>
	<p>Dialogs come in many forms (refer to the documentation or see the Dialog 
	pallete on the GUI designer of your IDE).&nbsp; Below is an example showing 
	a typical text-based one that gets a user to confirm or cancel an action.&nbsp; 
	It is common in Android development examples to see this amount of code 
	being presented each time a Dialog is required, though it might be possible 
	to cut down on this with some utility code that popped up a Dialog of this 
	type given just a few parameters.&nbsp; Question: how would you do this?</p>
	<p>In the example below, the Dialog itself is created in relation to a user 
	hitting the Back Button with the intention of leaving the app.&nbsp; This 
	illustrates how to block a user doing that - or potentially block it.&nbsp; 
	In this case the user is required to confirm that they wish to leave the 
	app.</p>
	<p><img alt="Intercepting the Back Button" src="img1E.jpg"></p>
	<h3><a name="Saving Data">Saving Data</a></h3>
	<p>A typical application often needs to save data to be restored at a later 
	date. Two ways to do this inAndroid are to use Key-Value Sets and to use 
	files.&nbsp; Other alternatives include saving data in a database, e.g. an
	<strong>sqlite</strong> database when using Android.</p>
	<p>In this part of the lab the aim is to experiment with key-value sets and 
	with file storage.&nbsp; Begin by reading the descriptions here:</p>
	<ul>
		<li>
		<a href="http://developer.android.com/training/basics/data-storage/shared-preferences.html">
		http://developer.android.com/training/basics/data-storage/shared-preferences.html</a></li>
		<li>
		<a href="http://developer.android.com/training/basics/data-storage/files.html">
		http://developer.android.com/training/basics/data-storage/files.html</a></li>
	</ul>

<p>Now modify your app by overriding the appropriate lifecycle methods in order 
to make the state of the puzzle be saved and restored when the app is destroyed 
and then restarted.</p>
	<p>Which activity lifecycle methods will you override to achieve this?</p>
	<p>You should already have the model as being serializable, so saving its 
	state in a file is straightforward: simply write it to an ObjectOutputStream 
	(and read it back in from an ObjectInputStream).</p>
	<h3><a name="Exercise">Exercise</a></h3>
	<p>If you get time, spend some time adding more features to the game.&nbsp; This part is 
	open-ended.&nbsp; For example, you might:</p>
	<ul>
		<li>add a special randomise button that creates puzzles to solve 
		that are a guaranteed number of steps away from the solution</li>
		<li>create an options dialog that allows the user to set the grid 
		size</li>
	</ul>
	<p>We'll go through a solution to this later in the course.</p>
	<h3><a name="Further reading">Further reading</a></h3>
	<p>Read the
	<a href="http://developer.android.com/training/basics/activity-lifecycle/starting.html">
	Activity Lifecycle</a> documentation, and download and run the 
	ActivityLifecycle.zip demo.</p>
	<p>&nbsp;</p>
	<p>&nbsp;</p>
